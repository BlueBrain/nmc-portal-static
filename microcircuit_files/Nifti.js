Nifti=function(E){var x=true;var F=new jDataView(E,0,E.length,true);F.seek(40);var y=new Array(4);y[0]=F.getInt16();if(y[0]<1||y[0]>7){x=false;F=new jDataView(E,0,E.length,false);F.seek(40);y[0]=F.getInt16()}y[1]=F.getInt16();y[2]=F.getInt16();y[3]=F.getInt16();if(y[0]!=3){alert("Unsupported dimensionality: "+y[0]);return}F.seek(70);var p=F.getInt16();if(!(p in Nifti.datafun)){alert("Unsupported data type: "+p);return}var C=Nifti.datafun[p];F.seek(108);var c=F.getFloat32();var B=F.getFloat32();var t=F.getFloat32();F.seek(280);var f=new Array(4);for(var A=0;A<3;A++){f[A]=new Array(4);for(var z=0;z<4;z++){f[A][z]=F.getFloat32()}}f[3]=new Array(4);f[3][0]=0;f[3][1]=0;f[3][2]=0;f[3][3]=1;f=$M(f);var a=f.inverse().elements;var g=new Array(4);var l=new Array(4);var s=new Array(4);for(var A=0;A<2;A++){for(var z=0;z<2;z++){for(var u=0;u<2;u++){var o=[A==0?0:y[1],z==0?0:y[2],u==0?0:y[3],1];var q=f.multiply($V(o));for(var m=1;m<4;m++){if(g[m]==undefined||q.e(m)<g[m]){g[m]=q.e(m)}if(l[m]==undefined||q.e(m)>l[m]){l[m]=q.e(m)}}}}}for(var A=1;A<4;A++){s[A]=l[A]-g[A]}var b;var e=y[1]*y[2]*y[3];if(F._isArrayBuffer){b=Nifti.arrayfun[p](E,c,e)}else{b=new Array(e);F.seek(c);for(var A=0;A<e;A++){b[A]=C(F)}}var h=Infinity;var n=-Infinity;for(var A=0;A<e;A++){var D=b[A];if(isNaN(D)){continue}if(B!=0){D=B*D+t}h=Math.min(h,D);n=Math.max(n,D)}this.littleEndian=x;this.datatype=p;this.size=s;this.cdata=b;this.M=f.elements;this.invM=a;this.posMin=g;this.posMax=l;this.vox_offset=c;this.dim=y;this.scl_slope=B;this.scl_inter=t;this.cal_min=h;this.cal_max=n;this.step=(n-h)/100;this.win_min=h;this.win_max=n;this.color_scale=ColorScale.grey;this.overlays=[{nii:this,color_scale:ColorScale.grey}]};Nifti.DT_UINT8=2;Nifti.DT_INT16=4;Nifti.DT_UINT16=512;Nifti.DT_INT32=8;Nifti.DT_UINT32=768;Nifti.DT_FLOAT32=16;Nifti.DT_FLOAT64=64;Nifti.DT_INT8=256;Nifti.datafun={2:function(a){return a.getUint8()},4:function(a){return a.getInt16()},512:function(a){return a.getUint16()},8:function(a){return a.getInt32()},768:function(a){return a.getUint32()},16:function(a){return a.getFloat32()},64:function(a){return a.getFloat64()},256:function(a){return a.getInt8()}};Nifti.writefun={2:function(a,b){return a.setUint8(b)},4:function(a,b){return a.setInt16(b)},512:function(a,b){return a.setUint16(b)},8:function(a,b){return a.setInt32(b)},768:function(a,b){return a.setUint32(b)},16:function(a,b){return a.setFloat32(b)},64:function(a,b){return a.setFloat64(b)},256:function(a,b){return a.setInt8(b)}};Nifti.arrayfun={2:function(b,c,a){return new Uint8Array(b,c,a)},4:function(b,c,a){return new Int16Array(b,c,a)},512:function(b,c,a){return new Uint16Array(b,c,a)},8:function(b,c,a){return new Int32Array(b,c,a)},768:function(b,c,a){return new Uint32Array(b,c,a)},16:function(b,c,a){return new Float32Array(b,c,a)},64:function(b,c,a){return new Float64Array(b,c,a)},256:function(b,c,a){return new Int8Array(b,c,a)}};Nifti.datasize={2:1,4:2,512:2,8:4,768:4,16:4,64:8,256:1};Nifti.overlay_limit=Infinity;Nifti.prototype.display=function(o,u,s,H){var K=this.cdata;var c=this.invM;if(s===undefined){s=this.posMin}if(H===undefined){H=this.posMax}var m=new Array(4);m[0]=3;for(var O=1;O<=3;O++){m[O]=H[O]-s[O]}var f=this.vox_offset;var a=this.dim;var p=this.datafun;var A=this.scl_slope;var M=this.scl_inter;var x=this.win_min;var J=this.win_max;var R=this.color_scale;var t=this.overlays;var y=J-x;var E=o.width;var P=o.height;var z=o.getContext("2d");var I=z.getImageData(0,0,E,P);var B=I.data;var V=u[0];var T=u[1];var e=m[V]/P;var W=m[T]/E;var l=s[T];if(u[5]<0){l=H[T];W*=-1}var F=new Array(4);F[V-1]=s[V];F[u[2]-1]=u[3];F[3]=1;if(u[4]<0){F[V-1]=H[V];e*=-1}var n=0;var q=[0,0,0,0];var D;var S;var C=1/y;K=[];A=[];M=[];R=[];x=[];C=[];for(var O=0;O<t.length&&O<Nifti.overlay_limit;O++){K.push(t[O].nii.cdata);A.push(t[O].nii.scl_slope);M.push(t[O].nii.scl_inter);R.push(t[O].color_scale);x.push(t[O].nii.win_min);C.push(1/(t[O].nii.win_max-t[O].nii.win_min))}for(var O=0;O<P;O++){F[T-1]=l;for(var N=0;N<E;N++){q[0]=c[0][0]*F[0]+c[0][1]*F[1]+c[0][2]*F[2]+c[0][3]*F[3];q[1]=c[1][0]*F[0]+c[1][1]*F[1]+c[1][2]*F[2]+c[1][3]*F[3];q[2]=c[2][0]*F[0]+c[2][1]*F[1]+c[2][2]*F[2]+c[2][3]*F[3];q[0]=~~q[0];q[1]=~~q[1];q[2]=~~q[2];if(q[0]<0||q[1]<0||q[2]<0||q[0]>=a[1]||q[1]>=a[2]||q[2]>=a[3]){n+=4}else{D=q[0]+a[1]*(q[1]+q[2]*a[2]);var G=0;var Q=0;var U=0;for(var L=0;L<t.length&&L<Nifti.overlay_limit;L++){S=K[L][D];if(A[L]!=0){S=A[L]*S+M[L]}S=(S-x[L])*C[L];if(L>0){if(S>0){G=(G+S)/2;Q=(G+S)/3;U/=2}}else{G=S;Q=S;U=S}}B[n++]=255*G;B[n++]=255*Q;B[n++]=255*U;B[n++]=255}F[T-1]+=W}F[V-1]+=e}z.putImageData(I,0,0)};Nifti.prototype.getValue=function(a){var f=this.invM;var e=this.dim;var c=[0,0,0,0];c[0]=~~(f[0][0]*a[0]+f[0][1]*a[1]+f[0][2]*a[2]+f[0][3]*a[3]);c[1]=~~(f[1][0]*a[0]+f[1][1]*a[1]+f[1][2]*a[2]+f[1][3]*a[3]);c[2]=~~(f[2][0]*a[0]+f[2][1]*a[1]+f[2][2]*a[2]+f[2][3]*a[3]);if(c[0]<0||c[0]>=e[1]){return NaN}if(c[1]<0||c[1]>=e[2]){return NaN}if(c[2]<0||c[2]>=e[3]){return NaN}var b=(c[0]*e[2]+c[1])*e[3]+c[2];var g=this.cdata[b];return g};Nifti.prototype.addOverlay=function(b,a){if(!$M(b.invM).eql($M(this.invM))||!$V(b.size).eql($V(this.size))){alert("Overlay must be in complete voxel-perfect alignment with the first Nifti.")}this.overlays.push({nii:b,color_scale:a})};Nifti.prototype.createMask=function(){var a={};for(var b in this){a[b]=this[b]}a.prototype=Nifti.prototype;a.cdata=new Uint8Array(this.cdata.length);a.scl_slope=0;a.win_min=0;a.win_max=255;a.datatype=Nifti.DT_UINT8;return a};Nifti.prototype.clone=function(){var a={};for(var b in this){a[b]=this[b]}a.prototype=Nifti.prototype;a.overlays=this.overlays.slice();return a};Nifti.prototype.toArray=function(){var g=this.dim;var e=this.datatype;var m=this.vox_offset;var c=this.data;var n=this.cdata;var h=g[1]*g[2]*g[3];var k=new Uint8Array(m+h*Nifti.datasize[e]);c.seek(0);for(var f=0;f<m;f++){k[f]=c.getUint8()}var j=new jDataView(k.buffer,0,k.length,this.littleEndian);j.seek(70);j.writeInt16(e);j.seek(112);j.writeFloat32(this.scl_slope);j.writeFloat32(this.scl_inter);if("buffer" in n){var l=new Uint8Array(n.buffer,m);var b=h*Nifti.datasize[e];for(var f=0;f<b;f++){k[m+f]=l[f]}}else{var a=Nifti.writefun[e];j.seek(m);for(var f=0;f<h;f++){a(j,n[f])}}return k};Nifti.prototype.toVoxelSpace=function(a){var b=new Array(4);var c=this.invM;b[0]=c[0][0]*a[0]+c[0][1]*a[1]+c[0][2]*a[2]+c[0][3]*a[3];b[1]=c[1][0]*a[0]+c[1][1]*a[1]+c[1][2]*a[2]+c[1][3]*a[3];b[2]=c[2][0]*a[0]+c[2][1]*a[1]+c[2][2]*a[2]+c[2][3]*a[3];b[3]=1;return b};Nifti.prototype.toRealSpace=function(a){var b=new Array(4);var c=this.M;b[0]=c[0][0]*a[0]+c[0][1]*a[1]+c[0][2]*a[2]+c[0][3]*a[3];b[1]=c[1][0]*a[0]+c[1][1]*a[1]+c[1][2]*a[2]+c[1][3]*a[3];b[2]=c[2][0]*a[0]+c[2][1]*a[1]+c[2][2]*a[2]+c[2][3]*a[3];b[3]=1;return b};Nifti.prototype.drawSphere=function(d,c,A,s){var a=d.slice(1,5);var z=d.slice(1,5);var f=d.slice(1,5);var h=d.slice(1,5);this.win_min=Math.min(this.win_min,A);this.win_max=Math.max(this.win_max,A);if(this.scl_slope!=0){A=(A-this.scl_inter)/this.scl_slope}f[3]=1;h[3]=1;z[3]=1;var o;if(s!==undefined){o=s[2]-1}f=this.toVoxelSpace(f);h=this.toVoxelSpace(h);z=this.toVoxelSpace(z);f[0]-=c;f[1]-=c;f[2]-=c;h[0]+=c;h[1]+=c;h[2]+=c;for(var x=0;x<3;x++){if(f[x]>h[x]){var p=f[x];f[x]=h[x];h[x]=p}f[x]=Math.floor(f[x]);h[x]=Math.ceil(h[x])}var e=c*c;var v=this.dim;var b=this.cdata;for(var x=f[0];x<=h[0];x++){for(var w=f[1];w<=h[1];w++){for(var u=f[2];u<=h[2];u++){var q=[x,w,u];var n=q[0]-z[0];var m=q[1]-z[1];var l=q[2]-z[2];if(n*n+m*m+l*l<=e){if(o!==undefined){var y=[x,w,u,1];var g=this.toRealSpace(y);g[o]=a[o];q=this.toVoxelSpace(g);q[0]=~~q[0];q[1]=~~q[1];q[2]=~~q[2]}var r=q[0]+v[1]*(q[1]+q[2]*v[2]);b[r]=A}}}}};