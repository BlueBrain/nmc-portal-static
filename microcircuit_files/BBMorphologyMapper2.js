if(window.BB===undefined){BB={}}BB.MorphologyMapper2=function(a,b){this.path=a;this.scene=b};BB.MorphologyMapper2.prototype=Object.create(Object.prototype);BB.MorphologyMapper2.prototype.init=function(a,b){var c=this;var d=new XMLHttpRequest();c.cb=a;c.cb2=b;DataFormats.getMultiArray(c.path,function(e){c.data=e;c.display(c.cb,c.cb2)},d);return d};BB.MorphologyMapper2.prototype.display=function(F,b){var ak=this.data;var W=ak[0].data;var T=ak[1].data;var J=ak[0].dim[0];var d=ak[0].dim[1];console.log("p_rows",J);var l=ak[1].dim[0];var H=ak[1].dim[1];console.log("s_rows",l);console.log("s_cols",H);var z=-1;var Z=0;var A=[];var h=[];var R=[];for(var am=0;am<l;am++){var G=T[am*H+1];if(G!=z){z=G;Z+=1;A.push(T[am*H]);h.push(G);R.push(am)}}console.log("nbSection",Z);console.log(h);console.log(A);console.log(R);var B=[new THREE.MeshLambertMaterial({color:0}),new THREE.MeshLambertMaterial({color:255}),new THREE.MeshLambertMaterial({color:16711680}),new THREE.MeshLambertMaterial({color:16711935}),];for(var aa=0;aa<Z;aa++){console.log("sectionIdx ",aa);var af=new THREE.BufferGeometry();var e=5;var O=(A[aa+1]||J)-A[aa];var ae=new Float32Array(O*6*3*e);var D=new Uint16Array(O*6*e);var M=af.attributes;M.index={itemSize:1,array:D,numItems:D.length};M.position={itemSize:3,array:ae,numItems:ae.length};var j={start:0,count:0,index:0};af.offsets=[j];var ad=0;var at=0;var C=0;var a=R[aa];var S=R[aa+1]||l;for(var ac=a;ac<S;ac++){var w=T[ac*H];var ap=T[(ac+1)*H]||J;var E=w*d;for(var ab=w;ab<ap-1;ab+=1){var I;I=E+d*1;var ai=new THREE.Vector3(W[E],W[E+1],W[E+2]);var ah=new THREE.Vector3(W[I],W[I+1],W[I+2]);b(ah);var u=W[E+3];var o=W[I+3];var ag=new THREE.Vector3(0,0,1);var f=new THREE.Vector3(ah.x-ai.x,ah.y-ai.y,ah.z-ai.z);var V=new THREE.Quaternion();var Q=new THREE.Vector3().crossVectors(ag,f);V.x=Q.x;V.y=Q.y;V.z=Q.z;V.w=Math.sqrt((ag.lengthSq()*f.lengthSq()))+ag.dot(f);V.normalize();if(ad>65000){j={start:at/3,count:0,index:at/3};af.offsets.push(j);ad=0}for(var Y=(ab==w?0:1);Y<2;Y++){for(var X=0;X<e;X++){var ar=X*Math.PI*2/e;var U=(Y===0?u:o);var L=Math.cos(ar)*U;var K=Math.sin(ar)*U;var P=new THREE.Vector3(L,K,Y===0?0:f.length());P.applyQuaternion(V);P.add(ai);ae[at]=P.x;at++;ae[at]=P.y;at++;ae[at]=P.z;at++;ad++}}for(var X=0;X<e;X++){var c=at/3-2*e;var ao=c+X%e;var an=c+(X+1)%e;var al=c+e+X%e;var aj=c+e+(X+1)%e;D[C]=al;C++;D[C]=an;C++;D[C]=ao;C++;D[C]=an;C++;D[C]=al;C++;D[C]=aj;C++;j.count+=6}E+=d*1}}console.log("before vertex normal");af.computeVertexNormals();mesh=new THREE.Mesh(af,B[h[aa]-1]);scene.add(mesh);mesh.geometry.computeBoundingBox();var aq=mesh.geometry.boundingBox.clone();this.cb(aq);this.needsUpdate=true}return aq};