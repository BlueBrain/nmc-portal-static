var smwSankey=smwSankey?smwSankey:{};(function(){var Q;var a,d;var r=8;var m,e,N,h,f;var P={main:{},count:false,probability:false,strength:false};var S={sourceDepth:"L",sourceSelectionM:undefined,targetSelectionM:undefined,targetDepth:"L",sourceSelectionL:undefined,targetSelectionL:undefined,weight:"main",};var o={main:'click on  left (pre-synaptic) or right (post-synaptic) boxes to focus on a circuit layer or morphological type (m-type). Click on a connection to focus on a pathway (m-type to m-type). For more info, click on "?" above.',firstLeftBack:'click on the far left bar to defocus the pre-synaptic layer of interest. Click on left (pre-synaptic) or right (post-synaptic) boxes to focus on a circuit layer or a morphological type. For more info, click on "?" above.',firstRightBack:'click on the far right bar to defocus the post-synaptic layer of interest. Click on left (pre-synaptic) or right (post-synaptic) boxes to focus on a circuit layer or a morphological type. For more info, click on "?" above.',maxZoomRight:'click on far right or left bar to defocus. Click on a box to focus on a morphological type. Click on a connection for pathway factsheet. For more info, click on "?" above.',maxZoomLeft:'click on the far right or left bar to defocus the morphological type of interest. Click on a connection for the pathway factsheet. For more info, click on "?" above.',maxZoomRightFull:'click on the far right bar to defocus the morphological type of interest. Click on a connection for the pathway factsheet. For more info, click on "?" above.',maxZoomLeftFull:'click on the far left bar to defocus the morphological type of interest. Click on a connection for the pathway factsheet. For more info, click on "?" above.',OneMorphToLayer:'click on the far left bar to defocus the morphological type of interest. Click on a box to focus on a morpgological type. Click on a connection to focus on a pathway. For more info, click on "?" above.',LayerToOneMorph:'click on the far right bar to defocus the morphological type of interest. Click on a box to focus on a morpgological type. Click on a connection to focus on a pathway. For more info, click on "?" above.',"default":' click on far right or left bar to defocus. Click on a box to focus on a morphological type. Click on a connection to focus on a pathways. For more info, click on "?" above.'};var B={L:"layer",ML:"mtype",ML_F:"mtype",m:"mtype"};var M={};M[["L","L"]]=["ML","L"];M[["ML","L"]]=["m","L"];M[["ML","ML"]]=["m","ML_F"];M[["L","ML"]]=["ML","ML"];M[["L","m"]]=["ML_F","m"];var x={};x[["L","L"]]=["L","ML"];x[["ML","L"]]=["ML","ML"];x[["ML","ML"]]=["ML_F","m"];x[["L","ML"]]=["L","m"];x[["m","L"]]=["m","ML_F"];var O={};O[["L","L"]]=["ML","ML"];O[["ML","L"]]=["m","ML_F"];O[["L","ML"]]=["ML_F","m"];O[["m","L"]]=["m","ML_F"];O[["L","m"]]=["ML_F","m"];var s={};s[["ML","L"]]=["L","L"];s[["m","L"]]=["ML","L"];s[["ML","ML"]]=["L","ML"];s[["L","m"]]=["L","ML"];s[["m","ML_F"]]=["ML","ML"];s[["ML_F","m"]]=["L","m"];var G={};G[["L","ML"]]=["L","L"];G[["L","m"]]=["L","ML"];G[["ML","ML"]]=["ML","L"];G[["m","L"]]=["ML","L"];G[["m","ML_F"]]=["m","L"];G[["ML_F","m"]]=["ML","ML"];var c;var D;var I;var i=function(){var Z=S.sourceDepth;var af=S.targetDepth;var ab=Z+":"+af;if(ab===c&&I===S.weight){return D}c=ab;I=S.weight;if(Z==="ML_F"){Z="M"}if(af==="ML_F"){af="M"}var V=Z+"_"+af;var aa={};switch(V){case"ML_L":aa=P[S.weight][V][S.sourceSelectionL];break;case"L_ML":aa=P[S.weight][V][S.targetSelectionL];break;case"ML_ML":aa=P[S.weight][V][S.sourceSelectionL][S.targetSelectionL];break;case"m_L":aa=P[S.weight][V][S.sourceSelectionM];break;case"L_m":aa=P[S.weight][V][S.targetSelectionM];break;case"m_M":aa=P[S.weight][V][S.sourceSelectionM];break;case"M_m":aa=P[S.weight][V][S.targetSelectionM];break;default:aa=P[S.weight][V]}if(S.sourceDepth==="ML_F"||S.targetDepth==="ML_F"){var g=[];var ae=[];var X=(S.sourceDepth==="ML_F");var W;var U;if(X){W=aa.links[0].target;U=S.sourceSelectionL}else{W=aa.links[0].source;U=S.targetSelectionL}var T=[];var Y={};for(var ad=0;ad<aa.nodes.length;ad++){if(aa.nodes[ad]===W||ad===W||aa.nodes[ad].name.indexOf(U)===0){g.push(aa.nodes[ad]);T.push(aa.nodes[ad]);Y[ad]=g.length-1}}for(ad=0;ad<aa.links.length;ad++){var ac=aa.links[ad];if("number"===typeof(ac.source)){if(ac.source in Y&&ac.target in Y){ae.push({source:Y[ac.source],target:Y[ac.target],value:ac.value})}}else{if(T.indexOf(ac.source)!==-1&&T.indexOf(ac.target)!==-1){ae.push({source:ac.source,target:ac.target,value:ac.value})}}}aa={nodes:g,links:ae}}D=aa;return aa};var j=function(g){return g.split(/[\s_]/)[0]};var F=function(g){var T=g.split(/[\s_]/);if(T.length>1){return T[0]}return false};var k={L1:"#ff5400",L23:"#ffc600",L4:"#96ff00",L5:"#0097ff",L6:"#4e00ff"};var p=function(X){var U=k[j(X.name)];if(F(X.name)){var g=40;var V=2;var W=1/d*X.y-0.5;var T=d3.rgb(U).darker(V*(W)).hsl();T.h+=(g*(W+0.5))%360;return T}else{return U}};var J=d3.format(",.0f"),v=function(g){switch(S.weight){case"count":case"main":return J(g)+" pathways";case"probability":return J(g)+" connections";case"strength":return J(g)+" synapses";default:return J(g)}},u=d3.scale.category20();var l=function(){a=Q.width();d=800};var n=function(g){l();e.attr("height",d+r*2);m.size([a,d]).layout(0);b(i(),m.link())};var b=function(g,T){A(g.nodes);m.relayout();z(g.links,m.link())};var z=function(T,U){d3.selectAll(".link").remove();var g=f.selectAll(".link").data(T).enter().append("path").attr("class","link").attr("d",U).style("stroke-width",function(V){return Math.max(1,V.dy)}).style("stroke",function(V){return V.color=p(V.source)}).sort(function(W,V){return(W.source.name<V.source.name)?1:-1});g.on("click",function(){var Y=d3.select(this).datum();var W=S.sourceDepth;var X=S.targetDepth;var V=O[[W,X]];if(V){S.sourceDepth=V[0];S.targetDepth=V[1];if(W==="L"&&X==="L"){S.sourceSelectionL=Y.source.name;S.targetSelectionL=Y.target.name}else{if(W==="ML"&&X==="L"){S.sourceSelectionM=Y.source.name;S.targetSelectionL=Y.target.name}else{if(W==="L"&&X==="ML"){S.sourceSelectionL=Y.source.name;S.targetSelectionM=Y.target.name}else{if(W==="m"&&X==="L"){S.sourceSelectionM=Y.source.name;S.targetSelectionL=Y.target.name}else{if(W==="L"&&X==="m"){S.sourceSelectionL=Y.source.name;S.targetSelectionM=Y.target.name}}}}}y()}else{if(W!=="L"&&X!=="L"){window.location.hash="/pathway/"+Y.source.name+"-"+Y.target.name}}})};var w=function(g){var T=g[[S.sourceDepth,S.targetDepth]];if(T===undefined){return}if(T[0]==="L"&&T[1]==="L"){window.location.hash="/circuit"}S.sourceDepth=T[0];S.targetDepth=T[1];y()};var q=function(){w(G)};var t=function(){w(s)};var K=function(){d3.selectAll(".sourceBreadcrumb").remove();var U=N.append("g").attr("class","sourceBreadcrumb").attr("transform","translate(0,0)");if(S.sourceDepth!=="L"){var T;if(S.sourceDepth==="ML"||S.sourceDepth==="ML_F"){T=S.sourceSelectionL}else{T=S.sourceSelectionM}if(T){var g=U.append("rect").attr("class","backbutton").attr("height",d).attr("width",m.nodeWidth()).style("fill",p({name:j(T)}));g.append("title").text("Go back to previous view");U.append("text").attr("x",5).attr("y",d/2).attr("dy",".7em").attr("transform",null).text("«").attr("text-anchor","start");U.on("click",function(){t()})}return m.nodeWidth()+m.nodePadding()}return 0};var R=function(){d3.selectAll(".targetBreadcrumb").remove();var U=N.append("g").attr("class","targetBreadcrumb").attr("transform","translate("+(a-m.nodeWidth())+", 0)");if(S.targetDepth!=="L"){var T;if(S.targetDepth==="ML"||S.targetDepth==="ML_F"){T=S.targetSelectionL}else{T=S.targetSelectionM}if(T){var g=U.append("rect").attr("class","backbutton").attr("height",d).attr("width",m.nodeWidth()).style("fill",p({name:j(T)}));g.append("title").text("Go back to previous view");U.append("text").attr("y",d/2).attr("dy",".7em").attr("text-anchor","end").attr("transform",null).text("»").attr("x",m.nodeWidth()-5);g.on("click",function(){q()})}return m.nodeWidth()+m.nodePadding()}return 0};var A=function(U){var g=K();var V=R();d3.selectAll(".node").remove();var T=h.selectAll(".node").data(U).enter().append("g").attr("class","node").attr("transform",function(W){if(W.sourceLinks.length>0){W.x+=g}else{W.x-=V}return"translate("+(W.x)+","+(W.y)+")"});T.append("rect").attr("height",function(W){return W.dy}).attr("stroke-linejoin","round").attr("width",m.nodeWidth()).style("fill",function(W){return W.color=p(W)}).append("title").text(function(W){return W.name+"\n"+v(W.value)});T.append("text").attr("x",-6).attr("y",function(W){return W.dy/2}).attr("dy",".35em").attr("text-anchor","end").attr("transform",null).text(function(W){return W.name}).filter(function(W){return W.x<a/2}).attr("x",6+m.nodeWidth()).attr("text-anchor","start");T.on("click",function(){var X=d3.select(this);if(X.datum().x<a/2){window.location.hash="/"+B[S.sourceDepth]+"/"+X.datum().name;var W=M[[S.sourceDepth,S.targetDepth]];if(W){if(S.sourceDepth==="L"){S.sourceSelectionL=X.datum().name}else{S.sourceSelectionM=X.datum().name}S.sourceDepth=W[0];S.targetDepth=W[1];y()}}else{window.location.hash="/"+B[S.targetDepth]+"/"+X.datum().name;var W=x[[S.sourceDepth,S.targetDepth]];if(W){if(S.targetDepth==="L"){S.targetSelectionL=X.datum().name}else{S.targetSelectionM=X.datum().name}S.sourceDepth=W[0];S.targetDepth=W[1];y()}}})};var H=function(){setTimeout(function(){if(S.weight==="main"){H()}else{y()}},100)};var y=function(){if(S.weight==="main"){H();return}var g=i();C(g);m.size([a,d]).nodes(g.nodes).links(g.links).layout(0);b(g,m.link())};var L=function(T){var g=Q.data(T);if(P[T]===false){d3.json(g,function(U){P[T]=U;S.weight=T;y()})}else{S.weight=T;y()}};var E=function(){var g=Q.data("main");d3.json(g,function(T){L("count");P.main=T;y()})};var C=function(){var g="";if(S.sourceDepth==="L"&&S.targetDepth==="L"){g=o.main}else{if(S.sourceDepth==="ML"&&S.targetDepth==="L"){g=o.firstLeftBack}else{if(S.sourceDepth==="L"&&S.targetDepth==="ML"){g=o.firstRightBack}else{if(S.sourceDepth==="m"&&S.targetDepth==="ML_F"){g=o.maxZoomRight}else{if(S.targetDepth==="m"&&S.sourceDepth==="ML_F"){g=o.maxZoomLeft}else{if(S.sourceDepth==="m"&&S.targetDepth==="M"){g=o.maxZoomRightFull}else{if(S.targetDepth==="m"&&S.sourceDepth==="M"){g=o.maxZoomLeftFull}else{if(S.targetDepth==="m"&&S.sourceDepth==="L"){g=o.OneMorphToLayer}else{if(S.sourceDepth==="m"&&S.targetDepth==="L"){g=o.LayerToOneMorph}else{g=o["default"]}}}}}}}}}$("#tipcontent").text(g)};smwSankey.init=function(T){Q=$(T);l();var g=0;$(window).resize(function(){clearTimeout(g);g=setTimeout(n,30)});$("body").on("overflowchanged",n);e=d3.select(T).append("svg").attr("width","100%").attr("height",d+r*2);N=e.append("g").attr("transform","translate(0,"+r+")");f=N.append("g");h=N.append("g");m=d3.sankey().nodeWidth(20).nodePadding(15);$("#sankey-count").click(function(){if(!$(this).hasClass("active")){L("count");$("#smw-graph-actions .active").removeClass("active");$(this).addClass("active")}});$("#sankey-probability").click(function(){if(!$(this).hasClass("active")){L("probability");$("#smw-graph-actions .active").removeClass("active");$(this).addClass("active")}});$("#sankey-strength").click(function(){if(!$(this).hasClass("active")){L("strength");$("#smw-graph-actions .active").removeClass("active");$(this).addClass("active")}});E()}}());$(smwSankey.init("#chart"));